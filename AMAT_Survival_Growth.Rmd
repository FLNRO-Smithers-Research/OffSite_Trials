---
title: "Import and analyse AMAT long-term plot data"
author: "Will MacKenzie"
date: "2022-08-03"
output: html_document
---
The off-site trial data will be in 5 related tables.
- trial_site table is the master table and gives location information for an opening or trial that locates the trial and gives general features of the opening. For RESULTS data this is pulled from the Silviculture tables
- project_info is the metadata about the purpose and methods of a set of related trials
- trial_planting is the information on each offsite species planting occurring in a trial along with the qualitative assessment fields. For RESULTS data this is pulled from the PLANTING tables
- plot_site is for quantitative plots established in a trial
- plot_trees is the measurements of individual trees in a plot

The unique identifier tying these tables together is the Trial_ID. For RESULTS data this is the opening number.


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
require(sf)
require(data.table)
require(tidyverse)
require(terra)
require(fasterize)
library(readr)
library(rmapshaper)
require(tictoc)
require(ggplot2)
require(forcats)
require(DataExplorer)
source("./_functions/doc_theme_pem.R")

```

```{r selected species and CFRG tables}

# spp.codes <- c("Fdi", "Fdc", "Lw", "Py", "Pw", "Cw","Ba", "Bg", "Pa", "Yc", "Bn", "Bp", "Ls", "Fd", "Pl", "Sn", "Bl", "Sx")
# old.codes <- c("Si", "Pp", "Bn")
# cfrg <- fread("./data/StockStands_v12_3.csv")
# cfrg.offsite <-
#   cfrg %>%
#   mutate(Spp=toupper(Species)) %>% rename(BGC = ZoneSubzone) %>% select(BGC,Spp,Suitability) %>%  filter(Suitability >0 & Suitability <4) %>% distinct() %>% group_by(BGC, Spp) %>% filter(Suitability == min(Suitability)) %>% data.frame %>% 
#   filter(!(Spp =='FD' & BGC == 'SBSdk'))
# bgc <- vect("./spatial_files/BC_BGCv12_Published_Fixed_2.gpkg")
# region <- vect("./spatial_files/Forest_Region_District.gpkg")
# bgc_region <- vect("./spatial_files/BGC_Region_District.gpkg")

```

```{r import spreadsheet data and export for SiteTools}
###---------This creates list of Openings with species of interest
file.name <- "./data/AMAT_MASTERDATA_ver_14.csv"

data <- fread(file.name) %>% select(Site, Sp, SLnum, Rep, HT10, Comments10)%>% mutate(HT10 = replace(HT10, HT10 == "9999", 0)) %>% mutate(HT10 = replace(HT10, HT10 == ".", 0)) %>% mutate(HT10 = as.numeric(HT10)) %>% mutate_if(is.character, as.factor) %>% 
  mutate(spseed = paste0(Sp, SLnum), spseedrep = paste0(Sp, SLnum,Rep), seedsite = paste0(SLnum, Site))

file.name <- "./data/AMAT_MASTERDATA_ver_14_Sites.csv"
site <- fread(file.name) %>% select(Site,BECvar, LAT_S, LONG_S, ELEV_S)
fwrite(site, "./data/AMAT_site_locations.csv")
###________ Bring into Site Tools and return for next chunk

library(ClimateNAr) 
input_file <- site
clm <- ClimateNA_API2 (ClimateBC_NA='NA', inputFile=input_file, period='Normal_1961_1990.nrm',MSY='Y')
head(clm)
dim(clm) 

```




```{r SI data summary by site}

sites = c("PORT","PARK", "NITI", "HOLB")


data1 <- data  %>%  filter(Site %in% sites)

HT_viol_10 <- ggplot(data1, aes(x= Sp, y=HT10, colour = Sp))+
         geom_violin(fill = "grey70", scale = "width",draw_quantiles = c(0.25, 0.5, 0.75))+
  #geom_jitter(width = 0.15)+
  coord_flip()+
    facet_wrap(~Site, ncol = 2)+
  #geom_hline(yintercept = c(15, 20, 25, 30),linetype="dashed", color = "grey10")+
  theme_pem()
HT_viol_10

data_sum <- data1 %>%  group_by(Site,spseed) %>% summarize(planted = n(), survived = sum(!HT10 == 0), height = mean(HT10 , na.rm = TRUE)) %>% 
  mutate(survival = survived/planted) 

```
```{r}
sls= c("18", "19")
spp = c("Fdi")
data1 <- data    %>%  filter(SLnum %in% sls) %>% left_join(clm)

HT_viol_10 <- ggplot(data1, aes(x= reorder(Site, -DD5), y=HT10, colour = SLnum)) +
         geom_violin(fill = "grey70", scale = "width", draw_quantiles = c(0.5, 0.75))+
  #geom_jitter(width = 0.15)+
  coord_flip()+
    facet_wrap(~Sp, ncol = 2)+
    #geom_hline(yintercept = c(15, 20, 25, 30),linetype="dashed", color = "grey10")+
  theme_pem()
HT_viol_10
```

